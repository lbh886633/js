<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
    *{
        margin: 0;
        padding: 0;
    }
    #btn,#update,#get{
        line-height: 30px;
        font-size: 16px;
        color: #fff;
        background-color: blue;
        padding: 0 30px;
    }
    </style>
</head>
<body>
    <button id="btn">添加数据</button>
    <button id="update">更新数据</button>
    <button id="get">获取数据</button>
    <script>
        //异步的处理方式是回调，可以用promise改写，也可以写一个发布订阅模式
        var indexDB = {
            db: null,
            dbName: "",
            objectStoreList: [],
            init: function (dbName, objectStoreList) {
                this.dbName = dbName;
                this.objectStoreList = objectStoreList.slice(0);
                this.openDB(dbName);
            },
            openDB: function (name, version) {
                var _this = this;
                version = version ? version : 1;//version不能为0
                var request = window.indexedDB.open(name, version);
                request.onerror = function (e) {
                    console.log(e.currentTarget.error.message);
                }
                request.onsuccess = function (e) {
                    _this.db = e.target.result;
                    console.log("DB " + name + " created");
                }
                request.onupgradeneeded = function (e) {
                    //创建objectStore（也就是表）
                    var db = e.target.result;
                    if (_this.objectStoreList.length != 0){
                        for(var i = 0; i < _this.objectStoreList.length; i++){
                            var item = _this.objectStoreList[i];
                            if (!db.objectStoreNames.contains(item.name)) {
                                //keyPath  键值 （也就是用哪一个字段做键）
                                var store = db.createObjectStore(item.name, { keyPath: item.keyPath });
                                //建立索引
                                if (item.index && item.index.length !== 0){
                                    for (var j = 0; j < item.index.length; j++){
                                        var innerItem = item.index[j];
                                        console.log(innerItem);
                                        store.createIndex(innerItem.name, innerItem.key, innerItem.property);
                                    }
                                }
                            }
                        }
                    }
                    
                    console.log('DB version changed to ' + version);
                }
            },
            closeDB: function () {
                if (this.db){
                    this.db.close();
                }
            },
            deleteDB: function (){
                if (this.dbName){
                    window.indexedDB.deleteDatabase(this.dbName);
                }
                else{
                    console.log("no such DB");
                }
                
            },
            //清除某个objectStore的数据
            clearObjectStore: function(storeName) {
                var transaction = this.db.transaction(storeName, 'readwrite');
                var store = transaction.objectStore(storeName);
                store.clear();
            },
            deleteObjectStore: function (storeName){
                if (db.objectStoreNames.contains(storeName)) {
                    db.deleteObjectStore(storeName);
                }
            },
            //以下方法为对数据的增删改查
            addData: function (storeName, data) {
                if (!Array.isArray(data)){
                    console.error("data must be array");
                    return;
                }
                //添加数据需要用到事务
                var transaction = this.db.transaction(storeName, 'readwrite');
                var store = transaction.objectStore(storeName);
                for (var i = 0; i < data.length; i++) {
                    store.add(data[i]);
                }
                console.log("inserted!");
            },
            getDataByKey: function(storeName, key, callback) {
                var transaction = this.db.transaction(storeName, 'readwrite');
                var store = transaction.objectStore(storeName);
                var request = store.get(key);
                var _this = this;
                request.onsuccess = function (e) {
                    var result = e.target.result;
                    if (typeof callback === "function"){
                        callback.call(_this, result);
                    }
                };
            },
            updateDataByKey: function(storeName, key, data) {
                var transaction = this.db.transaction(storeName, 'readwrite');
                var store = transaction.objectStore(storeName);
                var _this = this;
                var request = store.get(key);
                var _this = this;
                request.onsuccess = function (e) {
                    var result = e.target.result;
                    result = Object.assign(result, data);
                    store.put(result);
                }
                console.log("updated!");
            },
            deleteDataByKey: function (storeName, key) {
                var transaction = this.db.transaction(storeName, 'readwrite');
                var store = transaction.objectStore(storeName);
                store.delete(key);
            },
            getAll: function(storeName) {
                var reList = [];
                var objectStore = this.db.transaction(storeName).objectStore(storeName);
                objectStore.openCursor().onsuccess = function (event) {
                    var cursor = event.target.result;
                    if (cursor) {
                        if(cursor.value) {
                            reList.push(cursor.value);
                        }
                        cursor.continue();
                    } else {
                    console.log('没有更多数据了！');
                    }
                };
                return reList;
            },
            //关于索引和游标的使用，需要在建表的时候建立索引
            //下面利用index获取数据
            //参数: objectStore indexName value(要查找的值) callback
            getDataByIndex: function (storeName, indexName, value, callback) {
                var transaction = this.db.transaction(storeName);
                var store = transaction.objectStore(storeName);
                var index = store.index(indexName);
                var _this = this;
                index.get(value).onsuccess = function (e) {
                    var result = e.target.result;
                    if (typeof callback === "function"){
                        callback.call(_this, result);
                    }
                }
            },
            //利用游标遍历
            getMultipleDataByIndex(storeName, indexName, value, callback) {
                var transaction = this.db.transaction(storeName);
                var store = transaction.objectStore(storeName);
                var index = store.index(indexName);
                var request = index.openCursor(IDBKeyRange.only(value))
                var values = [], _this = this;
                request.onsuccess = function (e) {
                    var cursor = e.target.result;
                    if (cursor) {
                        var value = cursor.value;
                        //这里是遍历体
                        values.push(value);
                        cursor.continue();
                    }
                    else{
                        if (typeof callback === "function") {
                            callback.call(_this, values);
                        }
                    }
                }
            }
        }

        
        var btn = document.getElementById("btn");
        indexDB.init("testDB", [
            {
                name: "students",
                keyPath: "id",
                //索引信息
                index: [
                    {name: "nameIndex", key: "name", property: {unique: true}},
                    { name: "ageIndex", key: "age", property: { unique: false}}
                ]

            }, 
            {
                name: "employees",
                keyPath: "id",
            }
            
        ]);//创建一个数据库和多张objectStore(表)。

        //添加数据
        btn.onclick = function (e) {
            var students = [{
                id: 1001,
                name: "Byron",
                age: 24
            }, {
                id: 1002,
                name: "Frank",
                age: 30
            }, {
                id: 1003,
                name: "Aaron",
                age: 26
            }, {
                    id: 1004,
                    name: "Aaron2",
                    age: 26
            }];
            indexDB.addData("students", students);
            
        }
        document.getElementById("get").onclick = function (e) {
            console.log(
                indexDB.getAll("students")
            )
            console.log("=========")
            indexDB.getDataByKey("students", 1001, function (result) {
                // console.log(this.db);  this指向indexDB 
                console.log(result);
            });

            //通过索引拿数据
            //在 索引名为 nameIndex中寻找  "Frank"
            //参数: objectStore indexName value(要查找的值) callback
            indexDB.getDataByIndex("students", "nameIndex", "Frank", function (result) {
                console.log(result);
            })

            //游标遍历索引
            indexDB.getMultipleDataByIndex("students", "ageIndex", 26, function (result) {
                //这里可以获取两条数据
                console.log(result);
            })
        }
        document.getElementById("update").onclick = function (e) {
            indexDB.updateDataByKey("students", 1001, {age: 19});
            indexDB.deleteDataByKey("students", 1003);
        }
    </script>
    
</body>
</html>